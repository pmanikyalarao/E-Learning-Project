<div class="chatbot-container">
  <div class="chat-header">Chatbot</div>
  <div class="chat-body">
    <div class="message bot">
      <span class="bicon">ðŸ¤–</span>
      <div class="text">Hi there ðŸ‘‹<br />How can I help you today?</div>
    </div>
    {% if chat %} 
      {% for i in chat%}
        <div class="message user">
          <div class="text">{{ i.user_message }}</div>
          <span class="uicon">You</span>
        </div>
        <div class="message bot">
          <span class="bicon">ðŸ¤–</span>
          <div class="text">{{ i.bot_message|safe }}</div>
        </div>
      {% endfor %} 
    {% endif %}
  </div>
  <div class="chat-footer">
    <form id="chatbotForm" method='post'>
        <input type="text" name="message" id="userMessage" placeholder="Write your question..." required/>
        <!-- <button>&gt;</button> -->
        <button type="submit">
            <img src="{{ url_for('chatbot_pg.static',filename='imgs/sendLogo.png') }}" alt="sendImg"/>
        </button>
    </form>
  </div>
</div>
<script>
  //handle chat messages
  document.getElementById("chatbotForm").addEventListener("submit", function (event) {

    event.preventDefault(); //prevent the default form submission

    let messageBox = document.getElementById("userMessage");
    let chatBody = document.getElementsByClassName("chat-body")[0];

    var xhr = new XMLHttpRequest();
    xhr.open("POST", "/chatbotMessage", true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

    let userMessage = messageBox.value;

    // appending the user message to the chat body
    chatBody.innerHTML +=
      '<div class="message user">' +
      '<div class="text">' +
      userMessage +
      "</div>" +
      '<span class="uicon">You</span>' +
      "</div>";

    // clear the input box
    messageBox.value = "";

    // add a loading animation for the bot response
    let loadingMessage = document.createElement("div");
    loadingMessage.classList.add("bot", "message");
    loadingMessage.innerHTML =
      '<span class="bicon">ðŸ¤–</span>' +
      '<div class="loading-dots">' +
      "<span></span><span></span><span></span>" +
      "</div>";
    chatBody.appendChild(loadingMessage);

    // scroll to the bottom of the chat body
    chatBody.scrollTop = chatBody.scrollHeight;

    xhr.onload = function () {
      if (xhr.status == 200) {
        // Update the page with the received data
        var response = xhr.responseText;

        // Remove the loading message
        chatBody.removeChild(loadingMessage);

        chatBody.innerHTML +=
          '<div class="message bot">' +
          '<span class="bicon">ðŸ¤–</span>' +
          '<div class="text">' +
          response +
          "</div>" +
          "</div>";

        // Scroll to the bottom of the chat body
        chatBody.scrollTop = chatBody.scrollHeight;
      } else {
        // Remove the loading message
        chatBody.removeChild(loadingMessage);

        chatBody.innerHTML +=
          '<div class="bot message">' +
          '<span class="bicon">ðŸ¤–</span>' +
          '<div class="text">error</div>' +
          "</div>";
      }
    };

    // Send the request with the user message
    xhr.send('message=' + encodeURIComponent(userMessage));
  });
</script>
